set.seed(123)
tol = 5e-4
data("mpdta", package = "did")

# Vignette example ----

gls_fips = c("IL" = 17, "IN" = 18, "MI" = 26, "MN" = 27,
             "NY" = 36, "OH" = 39, "PA" = 42, "WI" = 55)

mpdta$gls = substr(mpdta$countyreal, 1, 2) %in% gls_fips
hmod_att = emfx(etwfe(
  lemp ~ lpop,
  tvar = year, gvar = first.treat, data = mpdta,
  vcov = ~countyreal,
  xvar = gls ## <= het. TEs by gls
))

hmod_att_known = structure(
  list(
    term = c(".Dtreat", ".Dtreat"),
    contrast = c("mean(TRUE) - mean(FALSE)", "mean(TRUE) - mean(FALSE)"),
    .Dtreat = c(TRUE, TRUE),
    gls = c(FALSE, TRUE),
    estimate = c(-0.0636770215654252, -0.0472387691288247),
    std.error = c(0.0372373208438418, 0.0266553873613548),
    statistic = c(-1.710032304216, -1.77220343821797),
    p.value = c(0.0872598995734215, 0.0763607931014942),
    conf.low = c(-0.136660829300118, -0.0994823683510443),
    conf.high = c(0.00930678616926726, 0.00500483009339487),
    predicted = c(8.58047839057103, 5.4198122639013),
    predicted_hi = c(8.58047839057103, 5.4198122639013),
    predicted_lo = c(8.65392156078294, 5.43931783410603)
  ),
  class = "data.frame", row.names = c(NA, -2L)
)

expect_equal(data.frame(hmod_att), hmod_att_known, tolerance = tol)

# Other (simulated) examples ----

mpdta$xvar = rep(sample(1:3, size = 500, replace = TRUE), each = 5) # a categorical var for every id
mpdta$emp = exp(mpdta$lemp)

# We'll continue with model 3 from the etwfe tests...
x3   = etwfe(lemp ~ lpop, tvar = year, gvar = first.treat, data = mpdta, vcov = ~countyreal)
x3x  = etwfe(lemp ~ lpop, tvar = year, gvar = first.treat, xvar = xvar, data = mpdta, vcov = ~countyreal)
x3xi = etwfe(lemp ~ lpop, tvar = year, gvar = first.treat, ivar = countyreal, xvar = xvar, data = mpdta, vcov = ~countyreal)

# Poisson version
x3xp = etwfe(emp ~ lpop, tvar = year, gvar = first.treat, xvar = xvar, data = mpdta, vcov = ~countyreal, family = "poisson")

# Known outputs ----

# from m3 |> emfx(...) |> data.frame() |> dput()
simple_known = structure(list(
    term = c(".Dtreat", ".Dtreat", ".Dtreat"), 
    contrast = c("mean(TRUE) - mean(FALSE)",  "mean(TRUE) - mean(FALSE)", "mean(TRUE) - mean(FALSE)"), 
    .Dtreat = c(TRUE,  TRUE, TRUE), 
    xvar = 1:3, estimate = c(0.00231608672993477, -0.0682913287282432,  -0.110401426879643), 
    std.error = c(0.0775433305507194, 0.0409008949705991,  0.0483119704753574), 
    statistic = c(0.0298682905865111, -1.66967810306677,  -2.28517747865316), 
    p.value = c(0.976172095007161, 0.0949830683373654,  0.0223024232048623), 
    conf.low = c(-0.14966604839076, -0.148455609806073,  -0.205091149033506), 
    conf.high = c(0.154298221850629, 0.0118729523495864,  -0.0157117047257802), 
    predicted = c(6.24310541346754, 5.35399856727654,  6.9416875962947), 
    predicted_hi = c(6.24310541346754, 5.35399856727654,  6.9416875962947), 
    predicted_lo = c(6.21452301280112, 5.38320182126802,  7.00911355933301)
    ), 
  class = "data.frame", 
  row.names = c(NA, -3L)
  )

calendar_known = structure(list(
  term = c(".Dtreat", ".Dtreat", ".Dtreat", ".Dtreat",  ".Dtreat", ".Dtreat", ".Dtreat", ".Dtreat", ".Dtreat", ".Dtreat",  ".Dtreat", ".Dtreat"), 
  contrast = c("mean(TRUE) - mean(FALSE)",  "mean(TRUE) - mean(FALSE)", "mean(TRUE) - mean(FALSE)", "mean(TRUE) - mean(FALSE)",  "mean(TRUE) - mean(FALSE)", "mean(TRUE) - mean(FALSE)", "mean(TRUE) - mean(FALSE)",  "mean(TRUE) - mean(FALSE)", "mean(TRUE) - mean(FALSE)", "mean(TRUE) - mean(FALSE)",  "mean(TRUE) - mean(FALSE)", "mean(TRUE) - mean(FALSE)"), 
  year = c(2004L,  2004L, 2004L, 2005L, 2005L, 2005L, 2006L, 2006L, 2006L, 2007L,  2007L, 2007L), 
  xvar = c(1L, 2L, 3L, 1L, 2L, 3L, 1L, 2L, 3L, 1L,  2L, 3L), 
  estimate = c(0.0285824006664193, -0.0292032539914757,  -0.0674259630383105, 0.00343655771256035, -0.106417783654013,  -0.146239094958541, 0.0340179041365802, -0.0707535871979825,  -0.126479272856661, -0.0279473865141986, -0.0669703630187497,  -0.10206212814911), 
  std.error = c(0.0841016878069682, 0.0439269455283795,  0.077325325086235, 0.0931024991980148, 0.0449118906623791, 0.0794093712580226,  0.0703265896214226, 0.032663463408232, 0.0521989672678245, 0.107544145192111,  0.0629135212513346, 0.0404103015222798), 
  statistic = c(0.339855256318067,  -0.664814128098405, -0.871977750667268, 0.0369115517001463, -2.36947904184215,  -1.84158484876263, 0.483713262930894, -2.16613854794562, -2.42302251321785,  -0.259868972544017, -1.0644828279633, -2.52564629078155), 
  p.value = c(0.733965533360152,  0.506169385094335, 0.38322051551865, 0.970555529100253, 0.0178131646339971,  0.0655358989516088, 0.62858937923149, 0.030300601312625, 0.0153919727655512,  0.794964845539156, 0.287110029452393, 0.0115485688785728), 
  conf.low = c(-0.13625387847427,  -0.115298485177952, -0.218980815300183, -0.179040987586218, -0.194443471829877,  -0.301878602659235, -0.103819678676936, -0.134772799088459, -0.228787368731782,  -0.238730037838883, -0.190278598811961, -0.181264863737183),  
  conf.high = c(0.193418679807108, 0.0568919771950008, 0.0841288892235617,  0.185914103011339, -0.0183920954781494, 0.00940041274215325,  0.171855486950097, -0.0067343753075059, -0.0241711769815394,  0.182835264810486, 0.0563378727744615, -0.0228593925610375 ), predicted = c(6.24310541346754, 5.35399856727654, 6.9416875962947,  6.22599129310736, 5.28022468831837, 6.88390771433203, 6.18498868679519,  5.23971022177469, 6.87524120765034, 6.21849318075244, 5.32315999682496,  6.93953886873007), 
  predicted_hi = c(6.24310541346754, 5.35399856727654,  6.9416875962947, 6.22599129310736, 5.28022468831837, 6.88390771433203,  6.18498868679519, 5.23971022177469, 6.87524120765034, 6.21849318075244,  5.32315999682496, 6.93953886873007), 
  predicted_lo = c(6.21452301280112,  5.38320182126802, 7.00911355933301, 6.2225547353948, 5.38664247197239,  7.03014680929057, 6.22482308532385, 5.40452077433995, 7.04346499969351,  6.27704500275946, 5.44060199869074, 7.08359680988481)
  ), 
  class = "data.frame", row.names = c(NA,  -12L)
  )

group_known = structure(list(
  term = c(".Dtreat", ".Dtreat", ".Dtreat", ".Dtreat",  ".Dtreat", ".Dtreat", ".Dtreat", ".Dtreat", ".Dtreat"), 
  contrast = c("mean(TRUE) - mean(FALSE)",  "mean(TRUE) - mean(FALSE)", "mean(TRUE) - mean(FALSE)", "mean(TRUE) - mean(FALSE)",  "mean(TRUE) - mean(FALSE)", "mean(TRUE) - mean(FALSE)", "mean(TRUE) - mean(FALSE)",  "mean(TRUE) - mean(FALSE)", "mean(TRUE) - mean(FALSE)"), 
  first.treat = c(2004,  2004, 2004, 2006, 2006, 2006, 2007, 2007, 2007), 
  xvar = c(1L,  2L, 3L, 1L, 2L, 3L, 1L, 2L, 3L), 
  estimate = c(-0.0165918155391758,  -0.104468398019131, -0.131486697798688, 0.0650147001486552, -0.00823270719099334,  -0.0996854650155194, -0.047449531031063, -0.0437002946391933,  -0.0474922669317142), 
  std.error = c(0.095679525284925, 0.0464316104695977,  0.0770006273237349, 0.0900953194717562, 0.0446906958291096, 0.0654288370517721,  0.11703269192669, 0.0559673062986647, 0.0609587072075615), 
  statistic = c(-0.173410303717194,  -2.24994129995845, -1.70760553996367, 0.721621284322506, -0.184215238502304,  -1.52357079091351, -0.405438260454485, -0.780818258538127, -0.779089142589675 ), 
  p.value = c(0.86232892660635, 0.0244526717939326, 0.0877095597479845,  0.47052734955287, 0.853844605459507, 0.127615964335858, 0.685155392040368,  0.434909393685443, 0.435927205432268), 
  conf.low = c(-0.204120239155518,  -0.195472682283736, -0.282405154140199, -0.111568881191617, -0.0958248614600826,  -0.227923629187333, -0.276829392221148, -0.153394199296298, -0.166969137602657 ), 
  conf.high = c(0.170936608077167, -0.0134641137545268, 0.0194317585428233,  0.241598281488928, 0.0793594470780959, 0.0285526991562936, 0.181930330159022,  0.0659936100179112, 0.0719846037392287), 
  predicted = c(6.24310541346754,  5.35399856727654, 6.9416875962947, 6.98109451691729, 6.50332738742894,  6.1118997739501, 5.87323593318632, 5.82883802468566, 5.73894975544937 ), 
  predicted_hi = c(6.24310541346754, 5.35399856727654, 6.9416875962947,  6.98109451691729, 6.50332738742894, 6.1118997739501, 5.87323593318632,  5.82883802468566, 5.73894975544937), 
  predicted_lo = c(6.21452301280112,  5.38320182126802, 7.00911355933301, 6.87322431011547, 6.48002400925965,  6.19663452762026, 5.92068546421739, 5.87253831932485, 5.78644202238108 )
  ), 
  class = "data.frame", row.names = c(NA, -9L)
  ) 

event_known = structure(list(
  term = c(".Dtreat", ".Dtreat", ".Dtreat", ".Dtreat",  ".Dtreat", ".Dtreat", ".Dtreat", ".Dtreat", ".Dtreat", ".Dtreat",  ".Dtreat", ".Dtreat"), 
  contrast = c("mean(TRUE) - mean(FALSE)",  "mean(TRUE) - mean(FALSE)", "mean(TRUE) - mean(FALSE)", "mean(TRUE) - mean(FALSE)",  "mean(TRUE) - mean(FALSE)", "mean(TRUE) - mean(FALSE)", "mean(TRUE) - mean(FALSE)",  "mean(TRUE) - mean(FALSE)", "mean(TRUE) - mean(FALSE)", "mean(TRUE) - mean(FALSE)",  "mean(TRUE) - mean(FALSE)", "mean(TRUE) - mean(FALSE)"),  
  event = c(0,  0, 0, 1, 1, 1, 2, 2, 2, 3, 3, 3),  
  xvar = c(1L, 2L, 3L, 1L, 2L,  3L, 1L, 2L, 3L, 1L, 2L, 3L),  
  estimate = c(0.0296676921457255,  -0.0165333901537918, -0.0665509945467262, 0.0127978756040239,  -0.0730932881026458, -0.130437635659714, -0.0398343985286598,  -0.164810552565259, -0.168223792043166, -0.0585518220070211,  -0.117442001865777, -0.144057941154733),  
  std.error = c(0.0612658189542638,  0.0317579895622811, 0.0377162360987916, 0.0826774136166018, 0.0452475610590735,  0.0523423892466851, 0.102340375378963, 0.0481114443433984, 0.0806216097393889,  0.127446179828382, 0.0824472984124654, 0.0810458050498115),  
  statistic = c(0.484245418605651,  -0.520605692667288, -1.76451845227627, 0.154792887733175, -1.6154083533302,  -2.49200767364617, -0.389234438325582, -3.42559976767509, -2.08658438583591,  -0.459423908083135, -1.42444936495361, -1.77748794112408),  
  p.value = c(0.628211707000591,  0.602641482875188, 0.0776447314809219, 0.876984598394752, 0.106222292464878,  0.0127023293065933, 0.697102730080766, 0.000613443593700679,  0.0369257199279611, 0.645929782864298, 0.154316432854731, 0.0754879931539222 ),  
  conf.low = c(-0.090411106487983, -0.0787779059172617, -0.140473458932767,  -0.149246877419437, -0.161776878166707, -0.233026833447993, -0.240417848435737,  -0.259107250722523, -0.326239243508011, -0.308341744437864, -0.279035737376836,  -0.302904800150418),  
  conf.high = c(0.149746490779434, 0.045711125609678,  0.00737146983931483, 0.174842628627485, 0.0155903019614153, -0.0278484378714344,  0.160749051378417, -0.0705138544079945, -0.0102083405783197,  0.191238100423822, 0.0441517336452812, 0.014788917840952),  
  predicted = c(6.24310541346754,  5.35399856727654, 6.9416875962947, 6.22599129310736, 5.28022468831837,  6.88390771433203, 6.18498868679519, 5.23971022177469, 6.87524120765034,  6.21849318075244, 5.32315999682496, 6.93953886873007),  
  predicted_hi = c(6.24310541346754,  5.35399856727654, 6.9416875962947, 6.22599129310736, 5.28022468831837,  6.88390771433203, 6.18498868679519, 5.23971022177469, 6.87524120765034,  6.21849318075244, 5.32315999682496, 6.93953886873007),  
  predicted_lo = c(6.21452301280112,  5.38320182126802, 7.00911355933301, 6.2225547353948, 5.38664247197239,  7.03014680929057, 6.22482308532385, 5.40452077433995, 7.04346499969351,  6.27704500275946, 5.44060199869074, 7.08359680988481)
  ),  
  class = "data.frame", row.names = c(NA,  -12L)
  )


event_pre_known = structure(list(
  term = c(".Dtreat", ".Dtreat", ".Dtreat", ".Dtreat",  ".Dtreat", ".Dtreat", ".Dtreat", ".Dtreat", ".Dtreat", ".Dtreat",  ".Dtreat", ".Dtreat"), 
  contrast = c("mean(TRUE) - mean(FALSE)",  "mean(TRUE) - mean(FALSE)", "mean(TRUE) - mean(FALSE)", "mean(TRUE) - mean(FALSE)",  "mean(TRUE) - mean(FALSE)", "mean(TRUE) - mean(FALSE)", "mean(TRUE) - mean(FALSE)",  "mean(TRUE) - mean(FALSE)", "mean(TRUE) - mean(FALSE)", "mean(TRUE) - mean(FALSE)",  "mean(TRUE) - mean(FALSE)", "mean(TRUE) - mean(FALSE)"), 
  event = c(0,  0, 0, 1, 1, 1, 2, 2, 2, 3, 3, 3), 
  xvar = c(1L, 2L, 3L, 1L, 2L,  3L, 1L, 2L, 3L, 1L, 2L, 3L), 
  estimate = c(0.0296676921457255,  -0.0165333901537918, -0.0665509945467262, 0.0127978756040239,  -0.0730932881026458, -0.130437635659714, -0.0398343985286598,  -0.164810552565259, -0.168223792043166, -0.0585518220070211,  -0.117442001865777, -0.144057941154733), 
  std.error = c(0.0612658189542638,  0.0317579895622811, 0.0377162360987916, 0.0826774136166018, 0.0452475610590735,  0.0523423892466851, 0.102340375378963, 0.0481114443433984, 0.0806216097393889,  0.127446179828382, 0.0824472984124654, 0.0810458050498115), 
  statistic = c(0.484245418605651,  -0.520605692667288, -1.76451845227627, 0.154792887733175, -1.6154083533302,  -2.49200767364617, -0.389234438325582, -3.42559976767509, -2.08658438583591,  -0.459423908083135, -1.42444936495361, -1.77748794112408), 
  p.value = c(0.628211707000591,  0.602641482875188, 0.0776447314809219, 0.876984598394752, 0.106222292464878,  0.0127023293065933, 0.697102730080766, 0.000613443593700679,  0.0369257199279611, 0.645929782864298, 0.154316432854731, 0.0754879931539222 ), 
  conf.low = c(-0.090411106487983, -0.0787779059172617, -0.140473458932767,  -0.149246877419437, -0.161776878166707, -0.233026833447993, -0.240417848435737,  -0.259107250722523, -0.326239243508011, -0.308341744437864, -0.279035737376836,  -0.302904800150418), 
  conf.high = c(0.149746490779434, 0.045711125609678,  0.00737146983931483, 0.174842628627485, 0.0155903019614153, -0.0278484378714344,  0.160749051378417, -0.0705138544079945, -0.0102083405783197,  0.191238100423822, 0.0441517336452812, 0.014788917840952), 
  predicted = c(6.24310541346754,  5.35399856727654, 6.9416875962947, 6.22599129310736, 5.28022468831837,  6.88390771433203, 6.18498868679519, 5.23971022177469, 6.87524120765034,  6.21849318075244, 5.32315999682496, 6.93953886873007), 
  predicted_hi = c(6.24310541346754,  5.35399856727654, 6.9416875962947, 6.22599129310736, 5.28022468831837,  6.88390771433203, 6.18498868679519, 5.23971022177469, 6.87524120765034,  6.21849318075244, 5.32315999682496, 6.93953886873007), 
  predicted_lo = c(6.21452301280112,  5.38320182126802, 7.00911355933301, 6.2225547353948, 5.38664247197239,  7.03014680929057, 6.22482308532385, 5.40452077433995, 7.04346499969351,  6.27704500275946, 5.44060199869074, 7.08359680988481)
  ), 
  class = "data.frame", row.names = c(NA,  -12L)
  ) 

event_pois_known = structure(list(
  term = c(".Dtreat", ".Dtreat", ".Dtreat", ".Dtreat",  ".Dtreat", ".Dtreat", ".Dtreat", ".Dtreat", ".Dtreat", ".Dtreat",  ".Dtreat", ".Dtreat"), 
  contrast = c("mean(TRUE) - mean(FALSE)",  "mean(TRUE) - mean(FALSE)", "mean(TRUE) - mean(FALSE)", "mean(TRUE) - mean(FALSE)",  "mean(TRUE) - mean(FALSE)", "mean(TRUE) - mean(FALSE)", "mean(TRUE) - mean(FALSE)",  "mean(TRUE) - mean(FALSE)", "mean(TRUE) - mean(FALSE)", "mean(TRUE) - mean(FALSE)",  "mean(TRUE) - mean(FALSE)", "mean(TRUE) - mean(FALSE)"), 
  event = c(0,  0, 0, 1, 1, 1, 2, 2, 2, 3, 3, 3), xvar = c(1L, 2L, 3L, 1L, 2L,  3L, 1L, 2L, 3L, 1L, 2L, 3L), 
  estimate = c(43.6561389121824, -12.4427498158629,  -61.7536201431925, 0.361368425090518, -45.5019326069491, -116.137399535932,  -3.56204305724179, -36.2676755251454, -183.002828473804, -45.2755639972384,  -39.0275074917792, -159.858707675829), 
  std.error = c(48.4599637767908,  16.6862579479082, 38.5324044892595, 86.9127396188547, 29.7237970341843,  59.002651982714, 54.266801882607, 13.3454135128782, 103.566539900288,  84.038559312259, 22.9115541970546, 120.211150304918), 
  statistic = c(0.900870234102216,  -0.745688449423899, -1.60264123045853, 0.00415783033275968, -1.53082503404995,  -1.96834202587972, -0.0656394505234969, -2.71761346998708, -1.76700726557049,  -0.538747503143284, -1.70339851919763, -1.32981597189899), 
  p.value = c(0.367657319144977,  0.455855638244813, 0.109013885433399, 0.996682540929514, 0.125812640757735,  0.0490286975259852, 0.947664879847666, 0.0065754604500854, 0.0772270115257975,  0.590061091300839, 0.0884935146440481, 0.183578912195033), 
  conf.low = c(-51.3236447824431,  -45.1472144305082, -137.275745179871, -169.984471025572, -103.759504277729,  -231.780472414402, -109.923020303322, -62.4242053691809, -385.989516681799,  -209.988113561899, -83.9333285478438, -395.468232813599), 
  conf.high = c(138.635922606808,  20.2617147987825, 13.7685048934856, 170.707207875753, 12.7556390638307,  -0.494326657461244, 102.798934188838, -10.11114568111, 19.98385973419,  119.436985567422, 5.87831356428541, 75.7508174619406), 
  predicted = c(564.137508779042,  251.397405268634, 1086.91704810995, 558.494995553466, 241.935782036228,  1054.39893859104, 544.619984750216, 230.437531572321, 1020.17009425511,  552.934105325149, 244.77209905643, 1095.89417855311), 
  predicted_hi = c(564.137508779042,  251.397405268634, 1086.91704810995, 558.494995553466, 241.935782036228,  1054.39893859104, 544.619984750216, 230.437531572321, 1020.17009425511,  552.934105325149, 244.77209905643, 1095.89417855311), 
  predicted_lo = c(536.857002673576,  258.180405992764, 1154.77540522949, 549.006968272766, 263.750338116477,  1174.72272740962, 548.182027807458, 266.705207097466, 1203.17292272891,  598.209669322388, 283.799606548209, 1255.75288622894)
  ), 
  class = "data.frame", row.names = c(NA,  -12L)
  ) 


# Tests ----

expect_warning(emfx(x3, by_xvar = TRUE))

e1 = emfx(x3x, collapse = TRUE)
e2 = emfx(x3x, collapse = TRUE, by_xvar = TRUE)
e3 = emfx(x3x, type = "calendar", collapse = TRUE)
e4 = emfx(x3x, type = "group", collapse = TRUE)
e5 = emfx(x3x, type = "event", collapse = TRUE)
e6 = emfx(x3x, type = "event", post_only = FALSE, collapse = TRUE)
e7 = emfx(x3xp, type = "event", collapse = TRUE)

for (col in c("estimate", "std.error", "conf.low", "conf.high")) {
  expect_equivalent(e1[[col]], simple_known[[col]], tolerance = tol)
  expect_equivalent(e2[[col]], simple_known[[col]], tolerance = tol)
  expect_equivalent(e3[[col]], calendar_known[[col]], tolerance = tol)
  expect_equivalent(e4[[col]], group_known[[col]], tolerance = tol)
  expect_equivalent(e5[[col]], event_known[[col]], tolerance = tol)
  expect_equivalent(e6[[col]], event_pre_known[[col]], tolerance = tol)
  expect_equivalent(e7[[col]], event_pois_known[[col]], tolerance = tol)
}
