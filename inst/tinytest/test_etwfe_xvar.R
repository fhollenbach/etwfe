set.seed(123)
data("mpdta", package = "did")
mpdta$xvar = rep(sample(1:3, size = 500, replace = TRUE), each = 5) # a categorical var for every id
mpdta$emp = exp(mpdta$lemp)

# Known outputs ----

# from etwfe(...) |> fixest::coeftable() |> dput()

x1_known = structure(
  c(-0.162555756558369, -0.219749560019782, -0.25749783774023, 
    -0.378366703228646, -0.0240345767446232, -0.217980682630389, 
    -0.215256870175742, -0.108575084650226, -0.107245847171758, -0.0903942016374607, 
    -0.160589500183835, 0.354255193236344, 0.329553774423836, 0.327558313720791, 
    0.41604072430716, -0.344925072153936, -0.259362390202076, 0.0945272527845298, 
    0.0921327371431593, 0.0954963116815227, 0.10380239380896, 0.204691184227697, 
    0.0637072247345655, 0.171681294662565, 0.157616265643188, 0.0624450561541818, 
    0.0628181015230178, 0.0669091815468514, 0.110463442441847, 0.470901470957854, 
    0.488476541239998, 0.492710260191241, 0.492973837789684, 0.198321188321475, 
    0.224124116369802, 0.202875296657005, -1.76436478062932, -2.30113138560408, 
    -2.4806541380359, -1.84847581324144, -0.377266108275202, -1.26968219256981, 
    -1.36570213294509, -1.73872987450191, -1.70724432244201, -1.35099846609489, 
    -1.45377960919856, 0.752291540979387, 0.674656296876129, 0.664809199616936, 
    0.843940778221693, -1.73922451288876, -1.15722660462889, 0.46593771810643, 
    0.0782823479656531, 0.0217954962314102, 0.0134427352618895, 0.0651249516815399, 
    0.706136250854692, 0.204789651553195, 0.172647726804663, 0.0826990423568374, 
    0.0883987066166522, 0.17730816960292, 0.146636049203268, 0.452230464321736, 
    0.500206603009728, 0.506479652897832, 0.399106892734528, 0.082611942435255, 
    0.247733433057168, 0.641463392419605), 
   dim = c(18L, 4L), dimnames = list(
      c(".Dtreat:first.treat::2004:year::2004", ".Dtreat:first.treat::2004:year::2005", 
        ".Dtreat:first.treat::2004:year::2006", ".Dtreat:first.treat::2004:year::2007", 
        ".Dtreat:first.treat::2006:year::2006", ".Dtreat:first.treat::2006:year::2007", 
        ".Dtreat:first.treat::2007:year::2007", "xvar_dm:year::2004", 
        "xvar_dm:year::2005", "xvar_dm:year::2006", "xvar_dm:year::2007", 
        ".Dtreat:first.treat::2004:year::2004:xvar_dm", ".Dtreat:first.treat::2004:year::2005:xvar_dm", 
        ".Dtreat:first.treat::2004:year::2006:xvar_dm", ".Dtreat:first.treat::2004:year::2007:xvar_dm", 
        ".Dtreat:first.treat::2006:year::2006:xvar_dm", ".Dtreat:first.treat::2006:year::2007:xvar_dm", 
        ".Dtreat:first.treat::2007:year::2007:xvar_dm"), 
      c("Estimate", "Std. Error", "t value", "Pr(>|t|)")
      ), 
   type = "Clustered (countyreal)")

x2_known = structure(
  c(-0.310697707534784, -0.357672024089544, -0.430908464577014, 
   -0.429785970258117, -0.293674348889617, -0.28347957231271, -0.294475038966784, 
   -0.36642978504524, -0.269687805730624, -0.259468103289313, -0.296956082380215, 
   -0.358335374584516, -0.146540424243248, -0.140221010410429, -0.143345600691115, 
   -0.160589500183842, 0.392220532829367, 0.362528937662507, 0.380509712774445, 
   0.416040724307168, -0.244514638501902, -0.274903207329125, -0.291973673100282, 
   -0.259362390202069, 0.0833293637759436, 0.0756944866486781, 0.075090408484425, 
   0.0945272527845368, 0.228154304120263, 0.233581389169293, 0.233111458651642, 
   0.231294671061222, 0.232542207662405, 0.237823987114664, 0.236933597901886, 
   0.235907052649979, 0.224800218878638, 0.229615498094059, 0.228860844278707, 
   0.22768187722869, 0.109632065225997, 0.11156740220935, 0.111080071103399, 
   0.110687370185236, 0.480366658608939, 0.498059102569731, 0.501589888459198, 
   0.493973177631027, 0.211505909019879, 0.221153699092365, 0.22076908431552, 
   0.224578453175786, 0.202163692441369, 0.201968369885728, 0.203900057675957, 
   0.203286558576466, -1.36178762321754, -1.53125223444199, -1.84850829328367, 
   -1.85817497777264, -1.26288621683665, -1.19197216290901, -1.2428589342096, 
   -1.55328033193192, -1.1996776830374, -1.13001128165585, -1.29753992351169, 
   -1.57384232309624, -1.33665660626905, -1.25682777974262, -1.29047091226366, 
   -1.45083851856897, 0.81650240665156, 0.727883369246827, 0.758607223808496, 
   0.842233431180203, -1.15606528269109, -1.24304141625192, -1.32252971019709, 
   -1.15488546000028, 0.412187583089928, 0.374783866857495, 0.368270658381865, 
   0.464995095821746, 0.173879391641106, 0.126340756450894, 0.0651202482952435, 
   0.0637328657696546, 0.207219874209123, 0.233838722725383, 0.214503504050399, 
   0.120990152241305, 0.230833839231661, 0.259014343944845, 0.195044991672559, 
   0.116157689219484, 0.181943857377532, 0.209403992471153, 0.197484828673842, 
   0.147453145193909, 0.414602462031243, 0.467026383425176, 0.448445704376038, 
   0.400060781296147, 0.248207649265468, 0.214436312698746, 0.186597635456058, 
   0.248690072063402, 0.68037895016154, 0.707980441183902, 0.712827602846604, 
   0.642137810522538), 
  dim = c(28L, 4L), 
  dimnames = list(
    c(".Dtreat:first.treat::2004:year::2004", 
       ".Dtreat:first.treat::2004:year::2005", ".Dtreat:first.treat::2004:year::2006", 
       ".Dtreat:first.treat::2004:year::2007", ".Dtreat:first.treat::2006:year::2004", 
       ".Dtreat:first.treat::2006:year::2005", ".Dtreat:first.treat::2006:year::2006", 
       ".Dtreat:first.treat::2006:year::2007", ".Dtreat:first.treat::2007:year::2004", 
       ".Dtreat:first.treat::2007:year::2005", ".Dtreat:first.treat::2007:year::2006", 
       ".Dtreat:first.treat::2007:year::2007", "xvar_dm:year::2004", 
       "xvar_dm:year::2005", "xvar_dm:year::2006", "xvar_dm:year::2007", 
       ".Dtreat:first.treat::2004:year::2004:xvar_dm", ".Dtreat:first.treat::2004:year::2005:xvar_dm", 
       ".Dtreat:first.treat::2004:year::2006:xvar_dm", ".Dtreat:first.treat::2004:year::2007:xvar_dm", 
       ".Dtreat:first.treat::2006:year::2004:xvar_dm", ".Dtreat:first.treat::2006:year::2005:xvar_dm", 
       ".Dtreat:first.treat::2006:year::2006:xvar_dm", ".Dtreat:first.treat::2006:year::2007:xvar_dm", 
       ".Dtreat:first.treat::2007:year::2004:xvar_dm", ".Dtreat:first.treat::2007:year::2005:xvar_dm", 
       ".Dtreat:first.treat::2007:year::2006:xvar_dm", ".Dtreat:first.treat::2007:year::2007:xvar_dm"
   ), 
   c("Estimate", "Std. Error", "t value", "Pr(>|t|)")
   ), 
  type = "Clustered (countyreal)"
  )

x3_known = structure(
  c(-0.00639742113590058, -0.0635747827546593, -0.104957226548348, 
   -0.0898676924683384, 0.0296535120337054, -0.0348976932803576, 
   -0.0436748277406258, 0.00433718352683639, 0.00729035799549547, 
   0.0160408535868578, 0.00676683200634815, 0.0359008690120653, 
   0.0579349653122929, 0.0870062121389959, 0.045884941299145, 0.036837377611076, 
   0.0354382255361927, -0.0143031350601187, -0.0326829184352982, 
   -0.0683671071756957, -0.0622544165462105, -0.0266215204150606, 
   -0.0828719365821442, -0.0557748584645896, 0.00015083499143906, 
   -0.0572949220312886, -0.054874460423846, -0.0663962243145736, 
   -0.066123902636791, 0.0403705207604729, 0.0246184900087865, 0.0604147687768027, 
   0.0405551528356379, 0.0437366413900371, 0.0475192310452789, 0.0801394917691681, 
   0.0322334656983262, 0.0691373916895806, 0.0608936742217196, 0.02284037809124, 
   0.0224662837123322, 0.0240801865955052, 0.039505794642687, 0.0419163650023645, 
   0.0455996445310053, 0.0509722204158315, 0.0464902247805541, 0.0308319946760152, 
   0.036657791125911, 0.0185336192107014, 0.0781957816023393, 0.0836227229691569, 
   0.0902890721035676, 0.082494826863615, 0.0690192371766928, 0.0785210207685315, 
   0.0741807312497329, 0.0481776819753544, 0.0560697381815005, 0.0622811913916592, 
   0.0467733382722519, 0.066947248133596, 0.0741304105793118, 0.0461305754805012, 
   -0.157746197180617, -1.4535817276802, -2.20873158592022, -1.12139084594136, 
   0.919960401131958, -0.504758603521586, -0.717230948843744, 0.18989105651013, 
   0.324502177967851, 0.666143242837327, 0.171287074910181, 0.856488128444346, 
   1.27051352939605, 1.70693392261901, 0.986980413963018, 1.19477763272101, 
   0.966731067195802, -0.771739987614509, -0.417962679898841, -0.81756614408397, 
   -0.689501122293078, -0.322705331075762, -1.20070780223183, -0.710317541961226, 
   0.00203334462869161, -1.18924198263831, -0.978682301783088, -1.06607184016498, 
   -1.41370928565983, 0.60301986841807, 0.332097041098231, 1.30964697811627, 
   0.874720607564958, 0.146690915561142, 0.0276470304709278, 0.26266088000467, 
   0.358037955961393, 0.61395122296401, 0.473567198003988, 0.849471720233783, 
   0.745693859430534, 0.505627383577955, 0.864067478310178, 0.392138944613664, 
   0.204493800665758, 0.0884564390371891, 0.324130560221063, 0.232741484620111, 
   0.334146785191573, 0.440633752819181, 0.676154200120483, 0.413995155527583, 
   0.490828468724901, 0.747053583524952, 0.230434223892652, 0.477839069873682, 
   0.998378439442251, 0.234910040302947, 0.328211212193459, 0.286906698953216, 
   0.158070816954006, 0.546769438464451, 0.739955432429094, 0.190917928915292
   ), 
  dim = c(32L, 4L), dimnames = list(c(
    ".Dtreat:first.treat::2004:year::2004", 
     ".Dtreat:first.treat::2004:year::2005", ".Dtreat:first.treat::2004:year::2006", 
     ".Dtreat:first.treat::2004:year::2007", ".Dtreat:first.treat::2006:year::2006", 
     ".Dtreat:first.treat::2006:year::2007", ".Dtreat:first.treat::2007:year::2007", 
     "xvar_dm:year::2004", "xvar_dm:year::2005", "xvar_dm:year::2006", 
     "xvar_dm:year::2007", ".Dtreat:first.treat::2004:year::2004:lpop_dm", 
     ".Dtreat:first.treat::2004:year::2005:lpop_dm", ".Dtreat:first.treat::2004:year::2006:lpop_dm", 
     ".Dtreat:first.treat::2004:year::2007:lpop_dm", ".Dtreat:first.treat::2006:year::2006:lpop_dm", 
     ".Dtreat:first.treat::2006:year::2007:lpop_dm", ".Dtreat:first.treat::2007:year::2007:lpop_dm", 
     ".Dtreat:first.treat::2004:year::2004:xvar_dm", ".Dtreat:first.treat::2004:year::2005:xvar_dm", 
     ".Dtreat:first.treat::2004:year::2006:xvar_dm", ".Dtreat:first.treat::2004:year::2007:xvar_dm", 
     ".Dtreat:first.treat::2006:year::2006:xvar_dm", ".Dtreat:first.treat::2006:year::2007:xvar_dm", 
     ".Dtreat:first.treat::2007:year::2007:xvar_dm", ".Dtreat:first.treat::2004:year::2004:xvar_dm:lpop_dm", 
     ".Dtreat:first.treat::2004:year::2005:xvar_dm:lpop_dm", ".Dtreat:first.treat::2004:year::2006:xvar_dm:lpop_dm", 
     ".Dtreat:first.treat::2004:year::2007:xvar_dm:lpop_dm", ".Dtreat:first.treat::2006:year::2006:xvar_dm:lpop_dm", 
     ".Dtreat:first.treat::2006:year::2007:xvar_dm:lpop_dm", ".Dtreat:first.treat::2007:year::2007:xvar_dm:lpop_dm"
    ), 
    c("Estimate", "Std. Error", "t value", "Pr(>|t|)")
    ), 
  type = "Clustered (countyreal)"
  )


x3p_known = structure(
  c(-0.0060200287762492, -0.0515151111518053, -0.0976701041146919, 
    -0.11699326115358, 0.00681469187944464, -0.0841562278932193, 
    -0.0688062392491395, 0.0263333372142436, 0.0242158323724011, 
    0.0369096343246467, 0.0136924085319925, 0.0153578168242671, 0.0342127013878385, 
    0.0477338722448758, 0.0380916842798292, 0.0754762272123928, 0.0660045019242574, 
    0.00133089672096127, -0.0645899921100563, -0.077939050343413, 
    -0.10385841679882, -0.0410719797566708, -0.131074594315921, -0.0745310900581143, 
    0.0233966626088734, 0.00860066329529138, 0.00705018233233587, 
    0.0164612724394587, -0.00190944414427215, 0.0890119504471188, 
    0.0520053159359514, 0.0157403334946728, 0.0397085012674217, 0.0448768385038862, 
    0.047549345833329, 0.0912528177268429, 0.0365865341409917, 0.0771762148640704, 
    0.0767835446338479, 0.0229275727534439, 0.0226799899759781, 0.0250724267917372, 
    0.0459114100049172, 0.0260179261653406, 0.029531830403924, 0.0307154880372757, 
    0.026424430234618, 0.031890795190955, 0.040149652206519, 0.0173761526309593, 
    0.107799548841862, 0.111890761334553, 0.111522271235138, 0.121561459037233, 
    0.0772436389377195, 0.0874743092542878, 0.0732425266292076, 0.0541709749318943, 
    0.0568485366224424, 0.056973376292084, 0.0568245282394023, 0.028977352428578, 
    0.0297117174327177, 0.0250343522235046, -0.151605539975095, -1.14792202100744, 
    -2.05407881860346, -1.28207834089889, 0.186262296756047, -1.09044254167483, 
    -0.896106575663455, 1.14854448385899, 1.06771794864326, 1.4721205342919, 
    0.298235417525317, 0.590278284543901, 1.15850256891942, 1.55406523858409, 
    1.44153285204712, 2.36670885001323, 1.64396198464555, 0.0765932913474758, 
    -0.599167555003479, -0.69656376821296, -0.931279605845195, -0.337870078904621, 
    -1.69689823160202, -0.852034050837171, 0.319440954396886, 0.158768848190465, 
    0.124016953666889, 0.288929207127678, -0.0336024636443551, 3.07177650775761, 
    1.75033018719694, 0.628749382214663, 0.879498063652014, 0.251000756569683, 
    0.0399680637629721, 0.199815166013374, 0.852239072854583, 0.275518250793248, 
    0.370195845432512, 0.250743860192533, 0.285647759603197, 0.140988331323529, 
    0.765523491760665, 0.555004095520051, 0.24665900393214, 0.12016885588942, 
    0.149434203117929, 0.0179470451193261, 0.100184055112599, 0.938947096005837, 
    0.549061156313636, 0.486075836967015, 0.351708948609717, 0.735461096525967, 
    0.0897159024304979, 0.394195193285981, 0.749392159138659, 0.873850992990495, 
    0.901301851605897, 0.772635552401638, 0.973194157675101, 0.00212788980200806, 
    0.0800613548543321, 0.52951314308097), 
  dim = c(32L, 4L), dimnames = list(
    c(".Dtreat:first.treat::2004:year::2004", ".Dtreat:first.treat::2004:year::2005", 
      ".Dtreat:first.treat::2004:year::2006", ".Dtreat:first.treat::2004:year::2007", 
      ".Dtreat:first.treat::2006:year::2006", ".Dtreat:first.treat::2006:year::2007", 
      ".Dtreat:first.treat::2007:year::2007", "xvar_dm:year::2004", 
      "xvar_dm:year::2005", "xvar_dm:year::2006", "xvar_dm:year::2007", 
      ".Dtreat:first.treat::2004:year::2004:lpop_dm", ".Dtreat:first.treat::2004:year::2005:lpop_dm", 
      ".Dtreat:first.treat::2004:year::2006:lpop_dm", ".Dtreat:first.treat::2004:year::2007:lpop_dm", 
      ".Dtreat:first.treat::2006:year::2006:lpop_dm", ".Dtreat:first.treat::2006:year::2007:lpop_dm", 
      ".Dtreat:first.treat::2007:year::2007:lpop_dm", ".Dtreat:first.treat::2004:year::2004:xvar_dm", 
      ".Dtreat:first.treat::2004:year::2005:xvar_dm", ".Dtreat:first.treat::2004:year::2006:xvar_dm", 
      ".Dtreat:first.treat::2004:year::2007:xvar_dm", ".Dtreat:first.treat::2006:year::2006:xvar_dm", 
      ".Dtreat:first.treat::2006:year::2007:xvar_dm", ".Dtreat:first.treat::2007:year::2007:xvar_dm", 
      ".Dtreat:first.treat::2004:year::2004:xvar_dm:lpop_dm", ".Dtreat:first.treat::2004:year::2005:xvar_dm:lpop_dm", 
      ".Dtreat:first.treat::2004:year::2006:xvar_dm:lpop_dm", ".Dtreat:first.treat::2004:year::2007:xvar_dm:lpop_dm", 
      ".Dtreat:first.treat::2006:year::2006:xvar_dm:lpop_dm", ".Dtreat:first.treat::2006:year::2007:xvar_dm:lpop_dm", 
      ".Dtreat:first.treat::2007:year::2007:xvar_dm:lpop_dm"),
    c("Estimate", "Std. Error", "t value", "Pr(>|t|)")
    ), 
  type = "Clustered (countyreal)")


# Tests ----

# No other controls
x1 = etwfe(lemp ~ 0, tvar = year, gvar = first.treat, xvar = xvar, data = mpdta, vcov = ~countyreal)
x1a = etwfe(lemp ~ 0, tvar = "year", gvar = "first.treat", xvar = "xvar", data = mpdta, vcov = ~countyreal) # chars instead of nse
x1r = etwfe(lemp ~ 0, tvar = "year", gvar = "first.treat", xvar = "xvar", data = mpdta, vcov = ~countyreal, gref = 0) # with explicit ref

expect_equal(fixest::coeftable(x1), x1_known)
expect_equal(fixest::coeftable(x1a), x1_known)
expect_equal(fixest::coeftable(x1r), x1_known)

# With never-treated control group
x2 = etwfe(lemp ~ 0,
  tvar = year, gvar = first.treat, xvar = xvar, data = mpdta, vcov = ~countyreal,
  cgroup = "never"
)

expect_equal(fixest::coeftable(x2), x2_known)

# With controls
x3 = etwfe(lemp ~ lpop, tvar = year, gvar = first.treat, xvar = xvar, data = mpdta, vcov = ~countyreal)
expect_equal(fixest::coeftable(x3), x3_known)

expect_error(
  etwfe(lemp ~ 0, tvar = NULL, gvar = first.treat, data = mpdta)
)

# Poisson version
x3p = etwfe(emp ~ lpop, tvar = year, gvar = first.treat, xvar = xvar, data = mpdta, vcov = ~countyreal, family = "poisson")
expect_equal(fixest::coeftable(x3p), x3p_known)
